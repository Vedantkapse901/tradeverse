<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìà Tradeverse | The Ultimate Trading Hub</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìà</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        gold: {
                            400: '#facc15',
                            500: '#eab308',
                            600: '#ca8a04',
                        },
                        dark: {
                            900: '#0a0a0a',
                            800: '#171717',
                            700: '#262626',
                            600: '#404040'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    animation: {
                        'marquee': 'marquee 25s linear infinite',
                        'float': 'float 6s ease-in-out infinite',
                        'float-delayed': 'float 6s ease-in-out 3s infinite',
                    },
                    keyframes: {
                        marquee: {
                            '0%': { transform: 'translateX(100%)' },
                            '100%': { transform: 'translateX(-100%)' },
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0px)' },
                            '50%': { transform: 'translateY(-20px)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        
        body {
            background-color: #0a0a0a;
            color: #f3f4f6;
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #0a0a0a;
        }
        ::-webkit-scrollbar-thumb {
            background: #ca8a04;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #eab308;
        }

        .nav-link.active {
            color: #facc15;
            border-bottom: 2px solid #facc15;
        }

        .market-tab.active {
            background-color: #eab308;
            color: #0a0a0a;
        }
        
        /* Messari Table Row Hover */
        .asset-row {
            cursor: pointer;
            transition: all 0.2s;
        }
        .asset-row:hover {
            background-color: rgba(234, 179, 8, 0.05);
        }
        .asset-row.active {
            background-color: rgba(234, 179, 8, 0.15);
            border-left: 3px solid #facc15;
        }

        .glass-panel {
            background: rgba(23, 23, 23, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(234, 179, 8, 0.2);
        }

        /* Typing Indicator Animation */
        .typing-dot {
            animation: typing 1.4s infinite ease-in-out both;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* News Card Hover */
        .news-card:hover {
            box-shadow: 0 4px 20px rgba(234, 179, 8, 0.15);
            border-color: rgba(234, 179, 8, 0.5);
            transform: translateY(-2px);
        }

        .hero-glow {
            box-shadow: 0 0 100px 30px rgba(234, 179, 8, 0.15);
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- Cookie Consent Banner -->
    <div id="cookie-banner" class="fixed bottom-0 w-full glass-panel border-t border-gold-500/50 p-4 z-50 transform translate-y-full transition-transform duration-500">
        <div class="max-w-7xl mx-auto flex flex-col sm:flex-row justify-between items-center gap-4">
            <div class="text-sm text-gray-300">
                <strong class="text-gold-400"><i class="fa-solid fa-cookie-bite mr-2"></i>Privacy & Cookies:</strong> We use cookies and AI diagnostics to analyze site traffic and improve your trading experience. By continuing, you consent to our privacy policy.
            </div>
            <div class="flex gap-3 whitespace-nowrap">
                <button onclick="acceptCookies()" class="bg-gold-500 hover:bg-gold-400 text-dark-900 px-5 py-2 rounded font-bold transition">Accept All</button>
                <button onclick="acceptCookies()" class="bg-dark-700 hover:bg-dark-600 text-gray-300 border border-dark-600 px-5 py-2 rounded transition">Decline</button>
            </div>
        </div>
    </div>

    <!-- Global Message Modal -->
    <div id="custom-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-80 backdrop-blur-sm transition-opacity">
        <div class="glass-panel p-8 rounded-xl max-w-md w-full text-center border-gold-500 border shadow-[0_0_30px_rgba(234,179,8,0.2)]">
            <h3 id="modal-title" class="text-2xl font-bold text-gold-400 mb-4">Notice</h3>
            <div id="modal-message" class="text-gray-300 mb-6 text-left leading-relaxed max-h-[60vh] overflow-y-auto pr-2"></div>
            <button onclick="closeModal()" class="px-6 py-2 bg-gold-500 text-dark-900 font-bold rounded hover:bg-gold-400 transition w-full">OK</button>
        </div>
    </div>

    <!-- Mock Razorpay Payment Modal -->
    <div id="payment-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-90 backdrop-blur-md">
        <div class="bg-white rounded-lg max-w-md w-full overflow-hidden shadow-2xl">
            <div class="bg-blue-600 p-6 text-center">
                <h3 class="text-2xl font-bold text-white mb-1">Tradeverse Checkout</h3>
                <p class="text-blue-200 text-sm">Secured by MockPay</p>
            </div>
            <div class="p-6 text-gray-800">
                <div class="flex justify-between mb-4 border-b pb-4">
                    <span class="font-semibold text-gray-600">Plan:</span>
                    <span id="pay-plan-name" class="font-bold">Pro Trader</span>
                </div>
                <div class="flex justify-between mb-6">
                    <span class="font-semibold text-gray-600">Amount:</span>
                    <span id="pay-plan-amount" class="font-bold text-xl text-green-600">‚Çπ1,499</span>
                </div>
                
                <div id="payment-processing" class="hidden text-center py-4">
                    <i class="fa-solid fa-circle-notch fa-spin text-3xl text-blue-600 mb-3"></i>
                    <p class="font-medium text-gray-600">Processing Payment...</p>
                </div>

                <div id="payment-actions">
                    <button onclick="processMockPayment()" class="w-full bg-blue-600 text-white font-bold py-3 rounded hover:bg-blue-700 transition mb-3 shadow-md">Pay Now</button>
                    <button onclick="closePaymentModal()" class="w-full bg-gray-200 text-gray-700 font-bold py-3 rounded hover:bg-gray-300 transition">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="login-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-80 backdrop-blur-sm transition-opacity">
        <div class="glass-panel p-8 rounded-xl max-w-sm w-full border-gold-500 border shadow-[0_0_30px_rgba(234,179,8,0.2)]">
            <h3 class="text-2xl font-bold text-white mb-2">Trader Login</h3>
            <p class="text-sm text-gray-400 mb-6">Access your live portfolio.</p>
            <form onsubmit="processLogin(event)" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase tracking-wide mb-1">Username</label>
                    <input type="text" id="login-username" class="w-full bg-dark-900 border border-dark-700 text-white rounded px-3 py-2 focus:outline-none focus:border-gold-500" required placeholder="e.g. Satoshi123">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase tracking-wide mb-1">Password</label>
                    <input type="password" class="w-full bg-dark-900 border border-dark-700 text-white rounded px-3 py-2 focus:outline-none focus:border-gold-500" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <div class="pt-2 flex gap-2">
                    <button type="submit" class="flex-grow bg-gold-600 hover:bg-gold-500 text-dark-900 font-bold py-2 rounded transition">Login</button>
                    <button type="button" onclick="toggleLoginModal()" class="px-4 py-2 bg-dark-700 hover:bg-dark-600 text-gray-300 rounded transition">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Deposit Modal -->
    <div id="deposit-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-80 backdrop-blur-sm transition-opacity">
        <div class="glass-panel p-8 rounded-xl max-w-sm w-full border-green-500 border shadow-[0_0_30px_rgba(34,197,94,0.2)]">
            <h3 class="text-2xl font-bold text-white mb-2">Deposit Funds</h3>
            <p class="text-sm text-gray-400 mb-6">Add capital to your trading account.</p>
            <form onsubmit="processDeposit(event)" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase tracking-wide mb-1">Amount (‚Çπ)</label>
                    <input type="number" id="deposit-amount" min="100" class="w-full bg-dark-900 border border-dark-700 text-white rounded px-3 py-2 focus:outline-none focus:border-green-500" required placeholder="50000">
                </div>
                <div class="pt-2 flex gap-2">
                    <button type="submit" class="flex-grow bg-green-600 hover:bg-green-500 text-white font-bold py-2 rounded transition">Confirm Deposit</button>
                    <button type="button" onclick="toggleDepositModal()" class="px-4 py-2 bg-dark-700 hover:bg-dark-600 text-gray-300 rounded transition">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Trade Execution Modal -->
    <div id="trade-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-80 backdrop-blur-sm transition-opacity">
        <div class="glass-panel p-8 rounded-xl max-w-sm w-full border-blue-500 border shadow-[0_0_30px_rgba(59,130,246,0.2)]">
            <h3 id="trade-asset-title" class="text-2xl font-bold text-white mb-1">Trade Asset</h3>
            <p id="trade-asset-price" class="text-sm text-gold-400 mb-6 font-semibold">Current Price: --</p>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase tracking-wide mb-1">Order Value (‚Çπ)</label>
                    <input type="number" id="trade-amount" min="10" class="w-full bg-dark-900 border border-dark-700 text-white rounded px-3 py-3 text-lg focus:outline-none focus:border-blue-500" placeholder="0.00">
                </div>
                <div class="pt-4 flex gap-3">
                    <button onclick="executeTrade('buy')" class="flex-grow bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded transition shadow-lg">Buy / Long</button>
                    <button onclick="executeTrade('sell')" class="flex-grow bg-red-600 hover:bg-red-500 text-white font-bold py-3 rounded transition shadow-lg">Sell / Short</button>
                </div>
                <button onclick="closeTradeModal()" class="w-full mt-2 py-2 text-gray-500 hover:text-gray-300 text-sm transition">Cancel Order</button>
            </div>
        </div>
    </div>

    <!-- Navbar -->
    <nav class="sticky top-0 z-40 glass-panel border-b-0 border-gold-500/30">
        <div class="max-w-[1400px] mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-20">
                <div class="flex items-center cursor-pointer" onclick="navigateTo('home')">
                    <i class="fa-solid fa-chart-line text-gold-500 text-3xl mr-3"></i>
                    <span class="text-2xl font-bold tracking-wider text-white">TRADE<span class="text-gold-500">VERSE</span></span>
                </div>
                <div class="hidden md:block">
                    <div class="ml-10 flex items-baseline space-x-8">
                        <button onclick="navigateTo('home')" class="nav-link active px-3 py-2 rounded-md text-sm font-medium hover:text-gold-400 transition" data-target="home">Home</button>
                        <button onclick="navigateTo('markets')" class="nav-link px-3 py-2 rounded-md text-sm font-medium hover:text-gold-400 transition" data-target="markets">Markets</button>
                        <button onclick="navigateTo('community')" class="nav-link px-3 py-2 rounded-md text-sm font-medium hover:text-gold-400 transition" data-target="community">Community</button>
                        <button onclick="navigateTo('ai-chat')" class="nav-link px-3 py-2 rounded-md text-sm font-medium hover:text-gold-400 transition" data-target="ai-chat">AI Analyst</button>
                        <button onclick="navigateTo('premium')" class="px-4 py-2 rounded-md text-sm font-bold bg-gold-600 text-dark-900 hover:bg-gold-500 transition shadow-[0_0_15px_rgba(234,179,8,0.4)]">Premium</button>
                        
                        <!-- Auth Section -->
                        <div id="auth-wrapper-desktop" class="inline-flex items-center ml-4 border-l border-dark-700 pl-4 space-x-3">
                            <button onclick="toggleLoginModal()" class="px-4 py-2 rounded-md text-sm font-bold bg-dark-800 text-gold-500 border border-gold-500/50 hover:bg-dark-700 transition"><i class="fa-solid fa-user mr-2"></i>Login</button>
                        </div>
                    </div>
                </div>
                <!-- Mobile menu button -->
                <div class="md:hidden">
                    <button onclick="toggleMobileMenu()" class="text-gold-500 hover:text-white focus:outline-none">
                        <i class="fa-solid fa-bars text-2xl"></i>
                    </button>
                </div>
            </div>
        </div>
        <!-- Mobile Menu -->
        <div id="mobile-menu" class="hidden md:hidden glass-panel border-t border-gold-500/30 absolute w-full z-50">
            <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                <button onclick="navigateTo('home'); toggleMobileMenu()" class="block w-full text-left px-3 py-2 text-base font-medium text-white hover:text-gold-400">Home</button>
                <button onclick="navigateTo('markets'); toggleMobileMenu()" class="block w-full text-left px-3 py-2 text-base font-medium text-white hover:text-gold-400">Markets</button>
                <button onclick="navigateTo('community'); toggleMobileMenu()" class="block w-full text-left px-3 py-2 text-base font-medium text-white hover:text-gold-400">Community</button>
                <button onclick="navigateTo('ai-chat'); toggleMobileMenu()" class="block w-full text-left px-3 py-2 text-base font-medium text-white hover:text-gold-400">AI Analyst</button>
                <button onclick="navigateTo('premium'); toggleMobileMenu()" class="block w-full text-left px-3 py-2 text-base font-bold text-gold-500">Premium</button>
                <div id="auth-wrapper-mobile" class="px-3 py-2 mt-2 border-t border-dark-700 space-y-2">
                    <button onclick="toggleLoginModal(); toggleMobileMenu()" class="w-full text-center px-4 py-2 rounded-md text-sm font-bold bg-dark-800 text-gold-500 border border-gold-500/50 hover:bg-dark-700 transition">Login</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="flex-grow relative">
        
        <!-- HOME PAGE -->
        <section id="page-home" class="page-section">
            <!-- Live Ticker -->
            <div class="bg-dark-900 border-b border-gold-500/20 overflow-hidden whitespace-nowrap py-2 flex items-center">
                <div class="text-gold-500 font-bold px-4 border-r border-gold-500/20 z-10 bg-dark-900 absolute left-0 flex items-center gap-2">
                    <i class="fa-solid fa-bolt text-gold-500"></i> LIVE
                </div>
                <div id="live-ticker-track-home" class="inline-block animate-marquee pl-32 text-sm text-gray-300">
                    <span class="mx-4"><i class="fa-solid fa-circle-notch fa-spin text-gold-500 mr-2"></i> Connecting to Live Markets...</span>
                </div>
            </div>

            <!-- Hero Section with Modern Web3/Trading Feel -->
            <div class="relative overflow-hidden min-h-[70vh] flex items-center">
                <!-- Decorative Background Elements -->
                <div class="absolute inset-0 z-0">
                    <div class="absolute inset-0 bg-[radial-gradient(circle_at_center,rgba(234,179,8,0.1)_0,rgba(10,10,10,1)_80%)]"></div>
                    <!-- Floating Bitcoin Icon -->
                    <div class="absolute top-[15%] left-[10%] animate-float opacity-30 text-gold-500 text-8xl md:text-[150px] rotate-12 blur-[2px]">
                        <i class="fa-brands fa-bitcoin"></i>
                    </div>
                    <!-- Floating Ethereum Icon -->
                    <div class="absolute bottom-[20%] right-[10%] animate-float-delayed opacity-20 text-blue-400 text-7xl md:text-[120px] -rotate-12 blur-[1px]">
                        <i class="fa-brands fa-ethereum"></i>
                    </div>
                    <!-- Floating Chart Icon -->
                    <div class="absolute top-[30%] right-[25%] animate-float opacity-10 text-green-500 text-6xl md:text-[100px] rotate-6 blur-[3px]">
                        <i class="fa-solid fa-chart-line"></i>
                    </div>
                </div>

                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 relative z-10 pt-16 pb-20 text-center w-full">
                    <div class="inline-flex items-center gap-2 bg-dark-800/80 border border-gold-500/30 text-gold-500 text-xs font-bold px-4 py-2 rounded-full mb-8 tracking-widest uppercase backdrop-blur-md">
                        <span class="relative flex h-2 w-2">
                          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-gold-400 opacity-75"></span>
                          <span class="relative inline-flex rounded-full h-2 w-2 bg-gold-500"></span>
                        </span>
                        Now with Gemini AI Insights
                    </div>
                    <h1 class="text-5xl md:text-7xl lg:text-8xl font-extrabold tracking-tight mb-6 leading-tight drop-shadow-2xl">
                        The Hub for <br>
                        <span class="text-transparent bg-clip-text bg-gradient-to-r from-gold-400 via-yellow-200 to-gold-600 hero-glow">Modern Traders</span>
                    </h1>
                    <p class="mt-4 max-w-2xl mx-auto text-xl text-gray-400 mb-10 drop-shadow-md">
                        Tradeverse is your definitive screener for Crypto, the NSE, and Global Forex. Access live data, chat with peers, and execute paper trades risk-free.
                    </p>
                    <div class="flex flex-col sm:flex-row justify-center gap-4">
                        <button onclick="navigateTo('markets')" class="px-8 py-4 bg-gold-500 text-dark-900 font-bold rounded-lg hover:bg-gold-400 transition text-lg shadow-[0_0_30px_rgba(234,179,8,0.4)] flex items-center justify-center gap-2">
                            Explore Markets <i class="fa-solid fa-arrow-trend-up"></i>
                        </button>
                        <button onclick="toggleLoginModal()" id="hero-login-btn" class="px-8 py-4 bg-dark-800 border border-gold-500 text-gold-500 font-bold rounded-lg hover:bg-gold-500 hover:text-dark-900 transition text-lg backdrop-blur-md">
                            Start Paper Trading
                        </button>
                    </div>

                    <!-- Mini Market Sentiment Widget -->
                    <div class="mt-16 max-w-3xl mx-auto glass-panel p-4 rounded-xl flex items-center justify-around border-gold-500/20 text-sm">
                        <div class="text-center">
                            <div class="text-gray-500 uppercase tracking-widest text-xs mb-1">Global Volume</div>
                            <div class="font-bold text-white text-lg">$142.8B</div>
                        </div>
                        <div class="w-px h-8 bg-dark-700"></div>
                        <div class="text-center">
                            <div class="text-gray-500 uppercase tracking-widest text-xs mb-1">Market Sentiment</div>
                            <div class="font-bold text-green-500 text-lg flex items-center justify-center gap-1"><i class="fa-solid fa-arrow-up-right-dots"></i> Bullish</div>
                        </div>
                        <div class="w-px h-8 bg-dark-700"></div>
                        <div class="text-center">
                            <div class="text-gray-500 uppercase tracking-widest text-xs mb-1">Active Traders</div>
                            <div class="font-bold text-gold-400 text-lg">12,409</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ad Banner Section (Home) -->
            <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 mb-16">
                <div class="relative rounded-2xl overflow-hidden bg-gradient-to-r from-blue-900 to-indigo-900 border border-blue-500/30 p-8 flex flex-col md:flex-row items-center justify-between group cursor-pointer shadow-2xl">
                    <div class="absolute inset-0 bg-black opacity-20 group-hover:opacity-10 transition"></div>
                    <div class="relative z-10 mb-4 md:mb-0">
                        <span class="text-xs font-bold bg-blue-500 text-white px-2 py-1 rounded uppercase tracking-wider mb-2 inline-block">Sponsored</span>
                        <h3 class="text-2xl font-bold text-white mb-2">Ready for Real Trading? Join Binance.</h3>
                        <p class="text-blue-200">Get up to $100 in welcome rewards when you sign up using our exclusive partner link.</p>
                    </div>
                    <button class="relative z-10 px-6 py-3 bg-yellow-400 text-black font-bold rounded hover:bg-yellow-300 transition whitespace-nowrap shadow-lg">Claim Reward <i class="fa-solid fa-arrow-right ml-2"></i></button>
                </div>
            </div>

            <!-- Features Grid -->
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-16">
                <h2 class="text-3xl font-bold text-center text-white mb-10 border-b border-dark-700 pb-4 inline-block mx-auto">Master Every Asset Class</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mt-6">
                    <div class="glass-panel p-8 rounded-2xl text-center transform transition duration-300 hover:-translate-y-2 hover:border-gold-500/50">
                        <div class="w-16 h-16 mx-auto bg-dark-800 rounded-full flex items-center justify-center border border-gold-500 mb-6 shadow-[0_0_15px_rgba(234,179,8,0.2)]">
                            <i class="fa-brands fa-bitcoin text-gold-500 text-3xl"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-white mb-3">Crypto Wiki</h3>
                        <p class="text-gray-400">Deep dive into block-chain technologies, tokenomics, and real-time charts of leading digital assets. From BTC to altcoins.</p>
                    </div>
                    <div class="glass-panel p-8 rounded-2xl text-center transform transition duration-300 hover:-translate-y-2 hover:border-gold-500/50">
                        <div class="w-16 h-16 mx-auto bg-dark-800 rounded-full flex items-center justify-center border border-gold-500 mb-6 shadow-[0_0_15px_rgba(234,179,8,0.2)]">
                            <i class="fa-solid fa-building-columns text-gold-500 text-3xl"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-white mb-3">NSE India</h3>
                        <p class="text-gray-400">Track India's booming economy. Analyze top equities from Nifty 50 to emerging mid-caps instantly with precision tools.</p>
                    </div>
                    <div class="glass-panel p-8 rounded-2xl text-center transform transition duration-300 hover:-translate-y-2 hover:border-gold-500/50">
                        <div class="w-16 h-16 mx-auto bg-dark-800 rounded-full flex items-center justify-center border border-gold-500 mb-6 shadow-[0_0_15px_rgba(234,179,8,0.2)]">
                            <i class="fa-solid fa-money-bill-trend-up text-gold-500 text-3xl"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-white mb-3">Forex Hub</h3>
                        <p class="text-gray-400">Monitor major and minor fiat pairs. Keep a pulse on global macroeconomic shifts affecting exchange rates 24/5.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- MARKETS DASHBOARD PAGE -->
        <section id="page-markets" class="page-section hidden max-w-[1400px] mx-auto px-4 sm:px-6 lg:px-8 py-8 flex flex-col">
            
            <!-- Live Ticker (Markets) -->
            <div class="bg-dark-900 border border-gold-500/20 rounded-lg overflow-hidden whitespace-nowrap py-2 flex items-center mb-6">
                <div class="text-gold-500 font-bold px-4 border-r border-gold-500/20 z-10 bg-dark-900 shadow-[5px_0_10px_rgba(10,10,10,1)] flex items-center gap-2">
                    <i class="fa-solid fa-satellite-dish text-gold-500 animate-pulse"></i> LIVE
                </div>
                <div id="live-ticker-track-markets" class="inline-block animate-marquee text-sm text-gray-300 w-full">
                    <span class="mx-4"><i class="fa-solid fa-circle-notch fa-spin text-gold-500 mr-2"></i> Syncing Data Streams...</span>
                </div>
            </div>

            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-gold-500"><i class="fa-solid fa-chart-line mr-2"></i> Data Screener & Charts</h2>
                <!-- Small ad in markets header -->
                <div class="hidden md:block bg-dark-800 border border-dark-700 text-xs px-4 py-2 rounded text-gray-400">
                    <span class="text-gold-500 font-bold">Ad:</span> Zero-fee crypto trading on <a href="#" class="text-blue-400 hover:underline">PartnerEx</a>
                </div>
            </div>
            
            <!-- Market Forums Toggle -->
            <div class="flex space-x-2 mb-6 border-b border-dark-700 pb-2 overflow-x-auto custom-scrollbar">
                <button onclick="switchMarket('crypto')" id="tab-crypto" class="market-tab active px-6 py-2 rounded-t-lg font-semibold transition whitespace-nowrap"><i class="fa-brands fa-bitcoin mr-2"></i>Crypto</button>
                <button onclick="switchMarket('nse')" id="tab-nse" class="market-tab px-6 py-2 rounded-t-lg font-semibold text-gray-400 hover:text-gold-400 transition whitespace-nowrap"><i class="fa-solid fa-building-columns mr-2"></i>NSE</button>
                <button onclick="switchMarket('forex')" id="tab-forex" class="market-tab px-6 py-2 rounded-t-lg font-semibold text-gray-400 hover:text-gold-400 transition whitespace-nowrap"><i class="fa-solid fa-money-bill-trend-up mr-2"></i>Forex</button>
            </div>

            <!-- Messari Style Dashboard Layout -->
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 h-[75vh] min-h-[600px]">
                
                <!-- LEFT: Asset Data Table Screener -->
                <div class="lg:col-span-1 flex flex-col glass-panel rounded-xl overflow-hidden border border-gold-500/20">
                    <div class="bg-dark-800 p-3 border-b border-dark-700 flex justify-between items-center">
                        <span class="font-bold text-sm text-gray-200">Asset Screener</span>
                        <i class="fa-solid fa-filter text-gray-500 text-xs cursor-pointer hover:text-gold-500"></i>
                    </div>
                    <div class="overflow-x-auto overflow-y-auto custom-scrollbar flex-grow bg-dark-900/50">
                        <table class="w-full text-left text-sm text-gray-300">
                            <thead class="text-xs text-gray-500 bg-dark-900 sticky top-0 z-10 border-b border-dark-700 shadow-sm">
                                <tr>
                                    <th class="px-4 py-3 font-semibold">Asset Name</th>
                                    <th class="px-3 py-3 font-semibold text-right">Action</th>
                                </tr>
                            </thead>
                            <tbody id="asset-table-body" class="divide-y divide-dark-800/50">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                        <!-- Login Prompt overlay if logged out (added dynamically via JS but placeholder below) -->
                        <div id="screener-login-prompt" class="p-4 text-center border-t border-dark-800 mt-2">
                            <p class="text-xs text-gray-500 mb-2">Want to execute paper trades?</p>
                            <button onclick="toggleLoginModal()" class="text-xs text-gold-500 hover:text-gold-400 font-bold underline">Login to Trade</button>
                        </div>
                    </div>
                </div>

                <!-- CENTER: Chart Container -->
                <div class="lg:col-span-2 flex flex-col">
                    <div class="glass-panel rounded-xl overflow-hidden border border-gold-500/20 relative w-full h-full shadow-lg" id="tv_chart_container">
                        <!-- TradingView Widget injects here -->
                    </div>
                </div>

                <!-- RIGHT: Market Specific News Section & Sentiment -->
                <div class="lg:col-span-1 flex flex-col h-full">
                    <div class="glass-panel rounded-xl border border-gold-500/20 p-4 h-full flex flex-col bg-dark-900/80">
                        
                        <div class="border-b border-dark-700 pb-3 mb-4 flex items-center justify-between">
                            <h3 class="text-lg font-bold text-white flex items-center">
                                <i class="fa-solid fa-newspaper text-gold-500 mr-2"></i> Live News
                            </h3>
                            <span id="news-badge" class="text-[10px] bg-gold-500 text-dark-900 px-2 py-1 rounded font-bold uppercase tracking-wider">CRYPTO</span>
                        </div>
                        
                        <!-- Gemini LLM Feature Button -->
                        <button onclick="analyzeNewsSentiment()" id="btn-analyze-sentiment" class="w-full mb-4 py-2 bg-dark-800 hover:bg-dark-700 border border-gold-500/50 text-gold-400 text-sm font-semibold rounded transition flex items-center justify-center gap-2 group shadow-[0_0_10px_rgba(234,179,8,0.1)]">
                            <i class="fa-solid fa-sparkles text-gold-500 group-hover:animate-pulse"></i>
                            Analyze Market Sentiment
                        </button>

                        <div id="news-container" class="overflow-y-auto custom-scrollbar pr-2 space-y-3 flex-grow">
                            <!-- News articles injected by JS -->
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- USER DASHBOARD PAGE (NEW) -->
        <section id="page-dashboard" class="page-section hidden max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 h-[calc(100vh-80px)] flex flex-col">
            <div class="flex items-center justify-between border-b border-gold-500/30 pb-4 mb-6">
                <div>
                    <h2 class="text-3xl font-bold text-white"><i class="fa-solid fa-address-card text-gold-500 mr-3"></i>User Dashboard</h2>
                    <p class="text-gray-400 text-sm mt-1" id="dash-greeting">Welcome back, Trader.</p>
                </div>
                <button onclick="toggleDepositModal()" class="px-5 py-2 bg-green-600 hover:bg-green-500 text-white font-bold rounded-lg transition shadow-[0_0_15px_rgba(34,197,94,0.3)]">
                    <i class="fa-solid fa-plus mr-2"></i>Deposit Funds
                </button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 flex-grow">
                <!-- Left Column: Balances & Portfolio -->
                <div class="lg:col-span-1 space-y-6">
                    <!-- Account Summary Card -->
                    <div class="glass-panel p-6 rounded-2xl border-gold-500/50 shadow-[0_0_20px_rgba(234,179,8,0.1)]">
                        <h3 class="text-gray-400 text-sm font-bold uppercase tracking-wider mb-4">Account Summary</h3>
                        
                        <div class="mb-4">
                            <p class="text-xs text-gray-500 mb-1">Total Portfolio Value (Est. INR)</p>
                            <p class="text-4xl font-extrabold text-white" id="dash-total-value">‚Çπ0.00</p>
                        </div>
                        
                        <div class="w-full h-px bg-dark-700 my-4"></div>
                        
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm text-gray-400">Available Cash</span>
                            <span class="font-bold text-green-400" id="dash-available-cash">‚Çπ0.00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-400">Invested Assets</span>
                            <span class="font-bold text-gold-400" id="dash-invested-value">‚Çπ0.00</span>
                        </div>
                    </div>

                    <!-- Current Holdings -->
                    <div class="glass-panel p-0 rounded-2xl overflow-hidden flex flex-col max-h-[400px]">
                        <div class="bg-dark-800 p-4 border-b border-dark-700">
                            <h3 class="text-gray-200 text-sm font-bold uppercase tracking-wider"><i class="fa-solid fa-briefcase text-gold-500 mr-2"></i>Current Holdings</h3>
                        </div>
                        <div class="overflow-y-auto custom-scrollbar flex-grow p-4">
                            <div id="dash-holdings-list" class="space-y-4">
                                <!-- Holdings injected here -->
                                <p class="text-gray-500 text-sm text-center py-4">No assets in portfolio.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Transaction History -->
                <div class="lg:col-span-2 glass-panel p-0 rounded-2xl overflow-hidden flex flex-col">
                    <div class="bg-dark-800 p-4 border-b border-dark-700 flex justify-between items-center">
                        <h3 class="text-gray-200 text-sm font-bold uppercase tracking-wider"><i class="fa-solid fa-clock-rotate-left text-gold-500 mr-2"></i>Transaction History</h3>
                        <span class="text-xs bg-dark-900 border border-dark-600 px-2 py-1 rounded text-gray-400">Paper Trades</span>
                    </div>
                    <div class="overflow-x-auto overflow-y-auto custom-scrollbar flex-grow">
                        <table class="w-full text-left text-sm text-gray-300">
                            <thead class="text-xs text-gray-500 bg-dark-900 sticky top-0 z-10 border-b border-dark-700">
                                <tr>
                                    <th class="px-6 py-4 font-semibold">Date & Time</th>
                                    <th class="px-6 py-4 font-semibold">Type</th>
                                    <th class="px-6 py-4 font-semibold">Asset</th>
                                    <th class="px-6 py-4 font-semibold text-right">Qty</th>
                                    <th class="px-6 py-4 font-semibold text-right">Value (‚Çπ)</th>
                                </tr>
                            </thead>
                            <tbody id="dash-history-body" class="divide-y divide-dark-800/50">
                                <!-- History injected here -->
                                <tr><td colspan="5" class="text-center py-8 text-gray-500">No transactions yet. Start trading in the Markets dashboard!</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- COMMUNITY CHAT PAGE -->
        <section id="page-community" class="page-section hidden max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8 h-[calc(100vh-80px)]">
            <div class="glass-panel border border-gold-500/30 rounded-2xl h-full flex flex-col">
                <div class="p-4 border-b border-gold-500/30 bg-dark-800/50 rounded-t-2xl flex justify-between items-center">
                    <h2 class="text-xl font-bold text-white"><i class="fa-solid fa-users text-gold-500 mr-2"></i> Tradeverse Community</h2>
                    <span class="text-xs font-semibold px-2 py-1 bg-green-500/20 text-green-400 rounded-full">‚óè 1,204 Online</span>
                </div>
                
                <div id="community-messages" class="flex-grow p-6 overflow-y-auto custom-scrollbar space-y-4">
                    <!-- Chat messages -->
                    <div class="flex items-start mb-4">
                        <div class="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center font-bold mr-3 border border-gray-600">JD</div>
                        <div>
                            <div class="bg-dark-700 px-4 py-2 rounded-2xl rounded-tl-none">
                                <span class="text-xs text-gold-400 font-bold block mb-1">John Doe</span>
                                <p class="text-sm">Anyone tracking the Reliance breakout on the daily chart? Looks promising.</p>
                            </div>
                            <span class="text-xs text-gray-500 mt-1 ml-1">10:42 AM</span>
                        </div>
                    </div>
                    
                    <div class="flex items-start mb-4">
                        <div class="w-10 h-10 rounded-full bg-purple-600 flex items-center justify-center font-bold mr-3 border border-gray-600">AT</div>
                        <div>
                            <div class="bg-dark-700 px-4 py-2 rounded-2xl rounded-tl-none">
                                <span class="text-xs text-gold-400 font-bold block mb-1">CryptoNinja</span>
                                <p class="text-sm">BTC is consolidating below $65k. Waiting for volume to pick up before longing.</p>
                            </div>
                            <span class="text-xs text-gray-500 mt-1 ml-1">10:45 AM</span>
                        </div>
                    </div>
                </div>

                <div class="p-4 border-t border-gold-500/30 bg-dark-800/50 rounded-b-2xl">
                    <form id="community-form" class="flex gap-2" onsubmit="sendCommunityMessage(event)">
                        <input type="text" id="community-input" class="flex-grow bg-dark-900 border border-dark-700 text-white rounded-lg px-4 py-3 focus:outline-none focus:border-gold-500 transition" placeholder="Share your market insights..." required>
                        <button type="submit" class="bg-gold-600 hover:bg-gold-500 text-dark-900 font-bold px-6 py-3 rounded-lg transition"><i class="fa-solid fa-paper-plane"></i></button>
                    </form>
                </div>
            </div>
        </section>

        <!-- AI CHATBOT PAGE -->
        <section id="page-ai-chat" class="page-section hidden max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8 h-[calc(100vh-80px)]">
            <div class="glass-panel border border-gold-500/50 rounded-2xl h-full flex flex-col shadow-[0_0_30px_rgba(234,179,8,0.1)]">
                <div class="p-5 border-b border-gold-500/30 bg-dark-800/80 rounded-t-2xl flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-gold-500 flex items-center justify-center border-2 border-white shadow-[0_0_10px_rgba(234,179,8,0.5)]">
                        <i class="fa-solid fa-robot text-dark-900 text-xl"></i>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold text-white">Tradeverse AI Expert</h2>
                        <p class="text-xs text-gold-400">Powered by Gemini AI ‚Ä¢ Always active</p>
                    </div>
                </div>
                
                <div id="ai-messages" class="flex-grow p-6 overflow-y-auto custom-scrollbar space-y-6">
                    <!-- AI Welcome Message -->
                    <div class="flex items-start">
                        <div class="w-8 h-8 rounded-full bg-gold-500 flex-shrink-0 flex items-center justify-center mr-3 mt-1">
                            <i class="fa-solid fa-robot text-dark-900 text-xs"></i>
                        </div>
                        <div class="bg-dark-800 border border-gold-500/20 text-gray-200 px-5 py-3 rounded-2xl rounded-tl-none max-w-[80%] leading-relaxed">
                            Hello! I am the Tradeverse AI Analyst. I can answer questions about Cryptocurrency fundamentals, NSE stock histories, Forex concepts, and general trading strategies. How can I assist your trading journey today?
                        </div>
                    </div>
                </div>

                <div class="p-4 border-t border-gold-500/30 bg-dark-800/50 rounded-b-2xl">
                    <form id="ai-form" class="flex gap-2" onsubmit="sendAiMessage(event)">
                        <input type="text" id="ai-input" class="flex-grow bg-dark-900 border border-dark-700 text-white rounded-lg px-4 py-3 focus:outline-none focus:border-gold-500 focus:ring-1 focus:ring-gold-500 transition" placeholder="Ask about stocks, crypto, or trading strategies..." required>
                        <button type="submit" id="ai-submit-btn" class="bg-gold-600 hover:bg-gold-500 text-dark-900 font-bold px-6 py-3 rounded-lg transition flex items-center gap-2">
                            <span>Ask AI</span>
                            <i class="fa-solid fa-sparkles"></i>
                        </button>
                    </form>
                </div>
            </div>
        </section>

        <!-- PREMIUM PAGE -->
        <section id="page-premium" class="page-section hidden max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
            <div class="text-center max-w-3xl mx-auto mb-16">
                <h2 class="text-4xl font-extrabold text-white mb-4">Elevate Your Trading Edge</h2>
                <p class="text-xl text-gray-400">Join the Tradeverse Elite. Get advanced indicators, priority AI access, and exclusive forum channels.</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 max-w-6xl mx-auto">
                <!-- Basic Tier -->
                <div class="glass-panel rounded-2xl p-8 border border-dark-700 flex flex-col">
                    <h3 class="text-2xl font-bold text-gray-300 mb-2">Retail Trader</h3>
                    <div class="text-4xl font-bold text-white mb-6">‚Çπ0 <span class="text-lg text-gray-500 font-normal">/mo</span></div>
                    <ul class="space-y-4 mb-8 flex-grow">
                        <li class="flex items-center text-gray-400"><i class="fa-solid fa-check text-green-500 mr-3"></i> Basic Live Charts</li>
                        <li class="flex items-center text-gray-400"><i class="fa-solid fa-check text-green-500 mr-3"></i> Public Community Chat</li>
                        <li class="flex items-center text-gray-400"><i class="fa-solid fa-check text-green-500 mr-3"></i> Standard AI Access</li>
                    </ul>
                    <button class="w-full py-3 rounded-lg border border-gray-600 text-gray-300 font-bold bg-dark-800 cursor-not-allowed">Current Plan</button>
                </div>

                <!-- Pro Tier (Gold) -->
                <div class="glass-panel rounded-2xl p-8 border-2 border-gold-500 relative transform md:-translate-y-4 flex flex-col shadow-[0_0_30px_rgba(234,179,8,0.2)]">
                    <div class="absolute top-0 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-gold-500 text-dark-900 px-4 py-1 rounded-full text-sm font-bold tracking-wide">MOST POPULAR</div>
                    <h3 class="text-2xl font-bold text-gold-400 mb-2">Pro Trader</h3>
                    <div class="text-4xl font-bold text-white mb-6">‚Çπ1,499 <span class="text-lg text-gray-500 font-normal">/mo</span></div>
                    <ul class="space-y-4 mb-8 flex-grow">
                        <li class="flex items-center text-gray-200"><i class="fa-solid fa-check text-gold-500 mr-3"></i> Multiple Chart Layouts</li>
                        <li class="flex items-center text-gray-200"><i class="fa-solid fa-check text-gold-500 mr-3"></i> Priority AI Analyst Processing</li>
                        <li class="flex items-center text-gray-200"><i class="fa-solid fa-check text-gold-500 mr-3"></i> Exclusive VIP Discord/Chat</li>
                        <li class="flex items-center text-gray-200"><i class="fa-solid fa-check text-gold-500 mr-3"></i> Premium News Feeds</li>
                    </ul>
                    <button onclick="openPaymentModal('Pro Trader', 1499)" class="w-full py-3 rounded-lg bg-gold-600 hover:bg-gold-500 text-dark-900 font-bold transition shadow-[0_0_15px_rgba(234,179,8,0.4)]">Subscribe Now</button>
                </div>

                <!-- Institutional Tier -->
                <div class="glass-panel rounded-2xl p-8 border border-dark-700 flex flex-col">
                    <h3 class="text-2xl font-bold text-gray-300 mb-2">Institutional</h3>
                    <div class="text-4xl font-bold text-white mb-6">‚Çπ9,999 <span class="text-lg text-gray-500 font-normal">/mo</span></div>
                    <ul class="space-y-4 mb-8 flex-grow">
                        <li class="flex items-center text-gray-400"><i class="fa-solid fa-check text-green-500 mr-3"></i> Everything in Pro</li>
                        <li class="flex items-center text-gray-400"><i class="fa-solid fa-check text-green-500 mr-3"></i> Direct API Access</li>
                        <li class="flex items-center text-gray-400"><i class="fa-solid fa-check text-green-500 mr-3"></i> 1-on-1 Trading Mentorship</li>
                        <li class="flex items-center text-gray-400"><i class="fa-solid fa-check text-green-500 mr-3"></i> Algorithmic Trading Bot setup</li>
                    </ul>
                    <button onclick="openPaymentModal('Institutional', 9999)" class="w-full py-3 rounded-lg border border-gold-500 text-gold-500 font-bold hover:bg-gold-500 hover:text-dark-900 transition">Subscribe Now</button>
                </div>
            </div>
        </section>

    </main>

    <!-- Global Ad Banner Footer -->
    <div class="bg-dark-900 border-t border-dark-700 py-4 text-center">
        <p class="text-sm text-gray-400">
            <span class="bg-dark-700 px-2 py-1 rounded text-xs mr-2 border border-dark-600">AD</span>
            Protect your digital assets with <strong class="text-gold-400 cursor-pointer hover:underline">Ledger Hardware Wallets</strong>. Get 20% off today.
        </p>
    </div>

    <!-- Footer -->
    <footer class="bg-black border-t border-dark-800 py-8 text-center text-gray-500 text-sm mt-auto">
        <p>&copy; 2026 Tradeverse. All Rights Reserved.</p>
        <p class="mt-2 text-xs">Trading involves high risk. This platform is for educational purposes only.</p>
    </footer>

    <script>
        /* --- GLOBAL & UTILS --- */
        const apiKey = "AIzaSyYourRealApiKeyGoesHere123456789"; // API key injected by environment
        let tvWidget = null;
        let activeMarket = 'crypto';
        
        // --- NEW: User Account State including Quantity Portfolio & History ---
        let userAccount = null; 
        let selectedTradeAsset = null;

        // Initialize Cookies on load
        document.addEventListener('DOMContentLoaded', () => {
            if (!localStorage.getItem('cookieConsent')) {
                setTimeout(() => {
                    document.getElementById('cookie-banner').classList.remove('translate-y-full');
                }, 1000);
            }
        });

        function acceptCookies() {
            localStorage.setItem('cookieConsent', 'true');
            document.getElementById('cookie-banner').classList.add('translate-y-full');
        }

        function showModal(message, title = "Notice") {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-message').innerHTML = message;
            document.getElementById('custom-modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('custom-modal').classList.add('hidden');
        }

        /* --- NAVIGATION --- */
        function navigateTo(pageId) {
            // Require login for dashboard
            if(pageId === 'dashboard' && !userAccount) {
                toggleLoginModal();
                return;
            }

            // Hide all sections
            document.querySelectorAll('.page-section').forEach(sec => sec.classList.add('hidden'));
            // Show target section
            document.getElementById(`page-${pageId}`).classList.remove('hidden');
            
            // Update active nav link
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
                if(link.getAttribute('data-target') === pageId) {
                    link.classList.add('active');
                }
            });

            // Initialize specific page logic
            if (pageId === 'markets') {
                if(!tvWidget) switchMarket('crypto');
            } else if (pageId === 'dashboard') {
                updateDashboardUI();
            }
        }

        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            menu.classList.toggle('hidden');
        }

        /* --- MARKETS, CHARTS & NEWS --- */
        const marketData = {
            crypto: [
                { name: 'Bitcoin', symbol: 'BINANCE:BTCUSDT', ticker: 'BTC' },
                { name: 'Ethereum', symbol: 'BINANCE:ETHUSDT', ticker: 'ETH' },
                { name: 'Solana', symbol: 'BINANCE:SOLUSDT', ticker: 'SOL' },
                { name: 'Cardano', symbol: 'BINANCE:ADAUSDT', ticker: 'ADA' },
                { name: 'Dogecoin', symbol: 'BINANCE:DOGEUSDT', ticker: 'DOGE' },
                { name: 'XRP', symbol: 'BINANCE:XRPUSDT', ticker: 'XRP' },
                { name: 'Polkadot', symbol: 'BINANCE:DOTUSDT', ticker: 'DOT' },
                { name: 'Polygon', symbol: 'BINANCE:MATICUSDT', ticker: 'MATIC' },
                { name: 'Chainlink', symbol: 'BINANCE:LINKUSDT', ticker: 'LINK' },
                { name: 'BNB', symbol: 'BINANCE:BNBUSDT', ticker: 'BNB' },
                { name: 'Avalanche', symbol: 'BINANCE:AVAXUSDT', ticker: 'AVAX' },
                { name: 'Uniswap', symbol: 'BINANCE:UNIUSDT', ticker: 'UNI' }
            ],
            nse: [
                { name: 'Reliance Ind.', symbol: 'BSE:RELIANCE', ticker: 'RELIANCE' },
                { name: 'TCS', symbol: 'BSE:TCS', ticker: 'TCS' },
                { name: 'HDFC Bank', symbol: 'BSE:HDFCBANK', ticker: 'HDFCBANK' },
                { name: 'Infosys', symbol: 'BSE:INFY', ticker: 'INFY' },
                { name: 'Tata Motors', symbol: 'BSE:TATAMOTORS', ticker: 'TATAMOTORS' },
                { name: 'ICICI Bank', symbol: 'BSE:ICICIBANK', ticker: 'ICICIBANK' },
                { name: 'SBI', symbol: 'BSE:SBIN', ticker: 'SBIN' },
                { name: 'Bharti Airtel', symbol: 'BSE:BHARTIARTL', ticker: 'BHARTI' },
                { name: 'ITC', symbol: 'BSE:ITC', ticker: 'ITC' },
                { name: 'Kotak Bank', symbol: 'BSE:KOTAKBANK', ticker: 'KOTAK' },
                { name: 'Larsen & Toubro', symbol: 'BSE:LT', ticker: 'LT' },
                { name: 'HUL', symbol: 'BSE:HINDUNILVR', ticker: 'HUL' }
            ],
            forex: [
                { name: 'Euro / US Dollar', symbol: 'FX:EURUSD', ticker: 'EUR/USD' },
                { name: 'British Pound / USD', symbol: 'FX:GBPUSD', ticker: 'GBP/USD' },
                { name: 'US Dollar / Yen', symbol: 'FX:USDJPY', ticker: 'USD/JPY' },
                { name: 'Aussie Dollar / USD', symbol: 'FX:AUDUSD', ticker: 'AUD/USD' },
                { name: 'US Dollar / CAD', symbol: 'FX:USDCAD', ticker: 'USD/CAD' },
                { name: 'US Dollar / Swiss', symbol: 'FX:USDCHF', ticker: 'USD/CHF' },
                { name: 'Kiwi Dollar / USD', symbol: 'FX:NZDUSD', ticker: 'NZD/USD' },
                { name: 'Euro / British Pound', symbol: 'FX:EURGBP', ticker: 'EUR/GBP' },
                { name: 'Euro / Yen', symbol: 'FX:EURJPY', ticker: 'EUR/JPY' },
                { name: 'British Pound / Yen', symbol: 'FX:GBPJPY', ticker: 'GBP/JPY' }
            ]
        };

        const newsData = {
            crypto: [
                { title: "Bitcoin Surges Past Key Resistance Level on Institutional Buying", time: "2 hours ago", source: "CoinTelegraph", url: "https://cointelegraph.com" },
                { title: "Ethereum Gas Fees Hit Yearly Low Following Dencun Upgrade", time: "4 hours ago", source: "Decrypt", url: "https://decrypt.co" },
                { title: "Solana DeFi TVL Crosses $5 Billion Mark Amid Airdrop Season", time: "5 hours ago", source: "Blockworks", url: "https://blockworks.co" },
                { title: "SEC Delays Decision on Spot Altcoin ETF Applications", time: "8 hours ago", source: "CryptoSlate", url: "https://cryptoslate.com" },
                { title: "Major Crypto Exchange Announces Expansion into European Markets", time: "12 hours ago", source: "CoinDesk", url: "https://coindesk.com" }
            ],
            nse: [
                { title: "RBI Holds Repo Rate Steady at 6.5%, Focuses on Inflation", time: "1 hour ago", source: "Economic Times", url: "https://economictimes.indiatimes.com" },
                { title: "Reliance Industries Unveils Ambitious Green Energy Gigafactory Plan", time: "3 hours ago", source: "Moneycontrol", url: "https://www.moneycontrol.com" },
                { title: "TCS Bags Multi-Million Dollar Deal from European Retail Giant", time: "5 hours ago", source: "Mint", url: "https://www.livemint.com" },
                { title: "Nifty 50 Hits Fresh All-Time High Led by Banking and Auto Stocks", time: "7 hours ago", source: "CNBC TV18", url: "https://www.cnbctv18.com" },
                { title: "Tata Motors EV Sales Surge 40% Year-on-Year in Latest Quarter", time: "10 hours ago", source: "Business Standard", url: "https://www.business-standard.com" }
            ],
            forex: [
                { title: "Fed Chair Jerome Powell Signals Potential Rate Cuts by Q3", time: "1 hour ago", source: "Reuters", url: "https://www.reuters.com/markets/currencies/" },
                { title: "ECB Maintains Hawkish Stance Despite Slight Drop in Eurozone Inflation", time: "3 hours ago", source: "Bloomberg", url: "https://www.bloomberg.com/markets/currencies" },
                { title: "Bank of Japan Considers Ending Negative Interest Rate Policy", time: "6 hours ago", source: "Financial Times", url: "https://www.ft.com/markets" },
                { title: "US Dollar Index (DXY) Weakens Amid Dovish Federal Reserve Commentary", time: "9 hours ago", source: "FXStreet", url: "https://www.fxstreet.com" },
                { title: "GBP/USD Volatile as UK Jobs Report Shows Unexpected Wage Growth", time: "11 hours ago", source: "DailyFX", url: "https://www.dailyfx.com" }
            ]
        };

        function switchMarket(marketType) {
            activeMarket = marketType;
            
            // Update Tabs UI
            document.querySelectorAll('.market-tab').forEach(tab => {
                tab.classList.remove('active', 'text-dark-900', 'bg-gold-500');
                tab.classList.add('text-gray-400');
            });
            const activeTab = document.getElementById(`tab-${marketType}`);
            activeTab.classList.add('active');
            activeTab.classList.remove('text-gray-400');
            
            // Update News Badge
            document.getElementById('news-badge').innerText = marketType.toUpperCase();

            // Populate Assets (Messari Table Style)
            const tableBody = document.getElementById('asset-table-body');
            tableBody.innerHTML = '';
            
            // Manage Login prompt in screener
            const loginPrompt = document.getElementById('screener-login-prompt');
            if(userAccount) {
                if(loginPrompt) loginPrompt.classList.add('hidden');
            } else {
                if(loginPrompt) loginPrompt.classList.remove('hidden');
            }
            
            marketData[marketType].forEach((asset, index) => {
                const tr = document.createElement('tr');
                tr.className = `asset-row border-b border-dark-800/50 ${index === 0 ? 'active' : ''}`;
                
                // Conditional Trade Button
                const tradeBtnHtml = userAccount ? `<button onclick="openTradeModal('${asset.name}', '${asset.ticker}')" class="text-xs bg-green-600/10 hover:bg-green-600 text-green-500 hover:text-white border border-green-600/30 px-3 py-1 rounded transition">Trade</button>` : '';

                tr.innerHTML = `
                    <td class="px-4 py-3" onclick="selectAsset(this, '${asset.symbol}')">
                        <div class="font-bold text-gray-200">${asset.name}</div>
                        <div class="text-xs text-gray-500">${asset.ticker}</div>
                    </td>
                    <td class="px-3 py-3 text-right flex justify-end gap-2">
                        ${tradeBtnHtml}
                        <button onclick="analyzeAsset('${asset.name}')" class="text-xs bg-dark-700 hover:bg-gold-500 hover:text-dark-900 text-gold-500 border border-gold-500/30 px-2 py-1 rounded transition group" title="Get AI Analysis">
                            <i class="fa-solid fa-sparkles"></i> <span class="hidden xl:inline">AI</span>
                        </button>
                    </td>
                `;
                tableBody.appendChild(tr);
            });

            // Populate News
            const newsContainer = document.getElementById('news-container');
            newsContainer.innerHTML = '';
            
            newsData[marketType].forEach(news => {
                const newsHTML = `
                    <a href="${news.url}" target="_blank" class="block news-card bg-dark-800/80 border border-dark-700 p-3 rounded-lg cursor-pointer transition-all duration-300">
                        <h4 class="text-sm font-bold text-gray-200 mb-2 leading-tight hover:text-gold-400 transition">${news.title}</h4>
                        <div class="flex justify-between items-center text-xs text-gray-500">
                            <span><i class="fa-regular fa-clock mr-1"></i> ${news.time}</span>
                            <span class="font-semibold text-gold-600">${news.source}</span>
                        </div>
                    </a>
                `;
                newsContainer.insertAdjacentHTML('beforeend', newsHTML);
            });

            // Load first asset chart by default
            if(marketData[marketType].length > 0) {
                initTradingView(marketData[marketType][0].symbol);
            }
        }

        function selectAsset(cellElement, symbol) {
            // Update active styling
            document.querySelectorAll('.asset-row').forEach(row => row.classList.remove('active'));
            cellElement.parentElement.classList.add('active');
            
            initTradingView(symbol);
        }

        function initTradingView(symbolStr) {
            document.getElementById('tv_chart_container').innerHTML = '';
            tvWidget = new TradingView.widget({
                "autosize": true,
                "symbol": symbolStr,
                "interval": "D",
                "timezone": "Etc/UTC",
                "theme": "dark",
                "style": "1",
                "locale": "en",
                "enable_publishing": false,
                "backgroundColor": "rgba(10, 10, 10, 1)",
                "gridColor": "rgba(38, 38, 38, 1)",
                "hide_top_toolbar": false,
                "hide_legend": false,
                "save_image": false,
                "container_id": "tv_chart_container",
                "toolbar_bg": "#0a0a0a"
            });
        }


        /* --- NEW GEMINI API FEATURES --- */
        async function analyzeAsset(assetName) {
            const prompt = `Act as an expert financial analyst. Provide a brief, 2-sentence fundamental analysis of the financial asset "${assetName}". What is its current overarching market narrative?`;
            
            showModal(`<div class="flex flex-col items-center py-4"><i class="fa-solid fa-circle-notch fa-spin text-gold-500 text-4xl mb-4"></i><p>Consulting Gemini AI regarding <strong>${assetName}</strong>...</p></div>`, `‚ú® AI Insight: ${assetName}`);
            
            try {
                const endpoint = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                const response = await fetchWithRetry(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                const data = await response.json();
                let text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                if(!text) throw new Error("Empty response");

                text = text.replace(/\*\*(.*?)\*\*/g, '<strong class="text-gold-400">$1</strong>').replace(/\n/g, '<br/>');
                showModal(`<div class="text-sm border-l-4 border-gold-500 pl-4 py-2">${text}</div>`, `‚ú® AI Insight: ${assetName}`);
            } catch (error) {
                console.error("Gemini Error:", error);
                showModal(`<div class="text-red-400 text-sm"><i class="fa-solid fa-triangle-exclamation mr-2"></i>Failed to fetch AI insights. Ensure API key is configured.</div>`, "Error");
            }
        }

        async function analyzeNewsSentiment() {
            const btn = document.getElementById('btn-analyze-sentiment');
            const originalHTML = btn.innerHTML;
            
            // Gather current headlines
            const currentHeadlines = newsData[activeMarket].map(n => n.title).join(" | ");
            const prompt = `Act as an expert financial analyst. Analyze these current news headlines for the ${activeMarket.toUpperCase()} market: "${currentHeadlines}". Provide a 2-3 sentence summary of the overall market sentiment (Is it strongly bullish, slightly bullish, neutral, slightly bearish, or strongly bearish, and why?). Format your response starting with the bolded sentiment state.`;

            btn.disabled = true;
            btn.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin text-gold-500"></i> Processing...`;

            try {
                const endpoint = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                const response = await fetchWithRetry(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                const data = await response.json();
                let text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                if(!text) throw new Error("Empty response");

                text = text.replace(/\*\*(.*?)\*\*/g, '<strong class="text-gold-400 text-lg">$1</strong>').replace(/\n/g, '<br/>');
                showModal(`<div class="text-sm bg-dark-800 p-4 rounded-lg border border-gold-500/30">${text}</div>`, `‚ú® ${activeMarket.toUpperCase()} Sentiment`);
            } catch (error) {
                console.error("Gemini Error:", error);
                showModal(`<div class="text-red-400 text-sm"><i class="fa-solid fa-triangle-exclamation mr-2"></i>Failed to analyze sentiment. Ensure API key is configured.</div>`, "Error");
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        }

        // Generic API Fetcher
        async function fetchWithRetry(url, options, retries = 5) {
            const delays = [1000, 2000, 4000, 8000, 16000];
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        const errBody = await response.text();
                        throw new Error(`HTTP error! status: ${response.status}, body: ${errBody}`);
                    }
                    return response;
                } catch (error) {
                    if (i === retries - 1) throw error;
                    await new Promise(res => setTimeout(res, delays[i]));
                }
            }
        }


        /* --- ORIGINAL AI CHATBOT (AI ANALYST PAGE) --- */
        async function sendAiMessage(e) {
            e.preventDefault();
            const input = document.getElementById('ai-input');
            const userText = input.value.trim();
            if(!userText) return;

            const chatContainer = document.getElementById('ai-messages');
            const submitBtn = document.getElementById('ai-submit-btn');
            
            // Append User Message
            const userMsgHTML = `
                <div class="flex items-start justify-end mb-4">
                    <div class="bg-dark-700 border border-gold-500/50 text-white px-5 py-3 rounded-2xl rounded-tr-none max-w-[80%]">
                        ${userText}
                    </div>
                    <div class="w-8 h-8 rounded-full bg-dark-800 flex-shrink-0 flex items-center justify-center ml-3 mt-1 border border-gold-500 text-gold-500 text-xs font-bold">
                        YOU
                    </div>
                </div>
            `;
            chatContainer.insertAdjacentHTML('beforeend', userMsgHTML);
            input.value = '';
            chatContainer.scrollTop = chatContainer.scrollHeight;

            // Loading indicator
            submitBtn.disabled = true;
            submitBtn.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i>`;
            
            const loadingId = 'loading-' + Date.now();
            const loadingHTML = `
                <div id="${loadingId}" class="flex items-start mb-4">
                    <div class="w-8 h-8 rounded-full bg-gold-500 flex-shrink-0 flex items-center justify-center mr-3 mt-1">
                        <i class="fa-solid fa-robot text-dark-900 text-xs"></i>
                    </div>
                    <div class="bg-dark-800 border border-gold-500/20 px-5 py-4 rounded-2xl rounded-tl-none flex gap-1 items-center h-[46px]">
                        <div class="w-2 h-2 bg-gold-500 rounded-full typing-dot"></div>
                        <div class="w-2 h-2 bg-gold-500 rounded-full typing-dot"></div>
                        <div class="w-2 h-2 bg-gold-500 rounded-full typing-dot"></div>
                    </div>
                </div>
            `;
            chatContainer.insertAdjacentHTML('beforeend', loadingHTML);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            try {
                const endpoint = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                const systemPrompt = "You are the Tradeverse AI Analyst, an expert financial advisor for a platform that tracks Crypto, the Indian NSE, and Forex. Provide concise, professional, and analytical answers. Format text with markdown if needed, but keep it readable in HTML. Never provide guaranteed financial advice.";
                
                const payload = {
                    contents: [{ parts: [{ text: userText }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    tools: [{ "google_search": {} }]
                };

                const response = await fetchWithRetry(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                let aiResponseText = data.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if(!aiResponseText) throw new Error("Empty response from AI");

                // Basic markdown to HTML (bolding and line breaks)
                aiResponseText = aiResponseText.replace(/\*\*(.*?)\*\*/g, '<strong class="text-gold-400">$1</strong>');
                aiResponseText = aiResponseText.replace(/\n/g, '<br/>');

                document.getElementById(loadingId).remove();
                
                const aiMsgHTML = `
                    <div class="flex items-start mb-4">
                        <div class="w-8 h-8 rounded-full bg-gold-500 flex-shrink-0 flex items-center justify-center mr-3 mt-1">
                            <i class="fa-solid fa-robot text-dark-900 text-xs"></i>
                        </div>
                        <div class="bg-dark-800 border border-gold-500/20 text-gray-200 px-5 py-3 rounded-2xl rounded-tl-none max-w-[80%] leading-relaxed text-sm">
                            ${aiResponseText}
                        </div>
                    </div>
                `;
                chatContainer.insertAdjacentHTML('beforeend', aiMsgHTML);

            } catch (error) {
                console.error("AI Error:", error);
                document.getElementById(loadingId).remove();
                
                let errorMsg = "I'm having trouble connecting to my analysis servers right now. Please try again later.";
                if(error.message.includes("API key")) {
                    errorMsg = "API configuration error. The platform requires a valid runtime API key to process AI requests.";
                }

                const aiErrorHTML = `
                    <div class="flex items-start mb-4">
                        <div class="w-8 h-8 rounded-full bg-red-500 flex-shrink-0 flex items-center justify-center mr-3 mt-1">
                            <i class="fa-solid fa-triangle-exclamation text-white text-xs"></i>
                        </div>
                        <div class="bg-red-900/20 border border-red-500/50 text-red-200 px-5 py-3 rounded-2xl rounded-tl-none max-w-[80%] text-sm">
                            ${errorMsg}
                        </div>
                    </div>
                `;
                chatContainer.insertAdjacentHTML('beforeend', aiErrorHTML);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = `<span>Ask AI</span><i class="fa-solid fa-sparkles"></i>`;
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }


        /* --- COMMUNITY CHAT --- */
        function sendCommunityMessage(e) {
            e.preventDefault();
            const input = document.getElementById('community-input');
            const msg = input.value.trim();
            if(!msg) return;

            const chatContainer = document.getElementById('community-messages');
            const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            const msgHTML = `
                <div class="flex items-start mb-4 justify-end">
                    <div class="text-right">
                        <div class="bg-gold-600 text-dark-900 px-4 py-2 rounded-2xl rounded-tr-none inline-block max-w-xs text-left">
                            <p class="text-sm font-medium">${msg}</p>
                        </div>
                        <span class="text-xs text-gray-500 mt-1 mr-1 block">${time}</span>
                    </div>
                    <div class="w-10 h-10 rounded-full bg-dark-700 flex items-center justify-center font-bold ml-3 border border-gold-500 text-gold-500">YOU</div>
                </div>
            `;
            
            chatContainer.insertAdjacentHTML('beforeend', msgHTML);
            input.value = '';
            chatContainer.scrollTop = chatContainer.scrollHeight;

            // Simulate random response
            setTimeout(() => {
                const replies = ["Agreed.", "Let's watch the volume.", "Bullish patterns forming.", "Careful with the resistance level here."];
                const reply = replies[Math.floor(Math.random() * replies.length)];
                
                const replyHTML = `
                <div class="flex items-start mb-4">
                    <div class="w-10 h-10 rounded-full bg-green-600 flex items-center justify-center font-bold mr-3 border border-gray-600 text-white">TR</div>
                    <div>
                        <div class="bg-dark-700 px-4 py-2 rounded-2xl rounded-tl-none">
                            <span class="text-xs text-gold-400 font-bold block mb-1">Trader_X</span>
                            <p class="text-sm">${reply}</p>
                        </div>
                        <span class="text-xs text-gray-500 mt-1 ml-1">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                    </div>
                </div>
                `;
                chatContainer.insertAdjacentHTML('beforeend', replyHTML);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }, 1500);
        }

        /* --- RAZORPAY MOCK SIMULATION --- */
        function openPaymentModal(planName, amount) {
            document.getElementById('pay-plan-name').innerText = planName;
            document.getElementById('pay-plan-amount').innerText = "‚Çπ" + amount.toLocaleString();
            document.getElementById('payment-modal').classList.remove('hidden');
        }

        function closePaymentModal() {
            document.getElementById('payment-modal').classList.add('hidden');
            document.getElementById('payment-actions').classList.remove('hidden');
            document.getElementById('payment-processing').classList.add('hidden');
        }

        function processMockPayment() {
            document.getElementById('payment-actions').classList.add('hidden');
            document.getElementById('payment-processing').classList.remove('hidden');
            
            setTimeout(() => {
                closePaymentModal();
                const fakePaymentId = "pay_" + Math.random().toString(36).substr(2, 14);
                showModal(`Payment Successful!\nTransaction ID: ${fakePaymentId}\n\nWelcome to Tradeverse Premium.`, "Subscription Activated");
            }, 2500);
        }

        /* --- NEW: LIVE TICKER LOGIC --- */
        let tickerData = [
            { symbol: "BTCUSDT", display: "BTC/USDT", price: 65000.00, change: 2.4, isCrypto: true },
            { symbol: "ETHUSDT", display: "ETH/USDT", price: 3500.00, change: 1.1, isCrypto: true },
            { symbol: "SOLUSDT", display: "SOL/USDT", price: 150.00, change: 5.2, isCrypto: true },
            { symbol: "NIFTY", display: "NIFTY 50", price: 22543.20, change: -0.3, isCrypto: false },
            { symbol: "RELIANCE", display: "RELIANCE", price: 2950.45, change: 1.8, isCrypto: false },
            { symbol: "EURUSD", display: "EUR/USD", price: 1.0845, change: -0.1, isCrypto: false }
        ];

        // Fetch generic current price globally across all assets logic
        function getCurrentEstimatedPrice(ticker) {
            const tData = tickerData.find(t => t.display.includes(ticker) || t.symbol.includes(ticker));
            if (tData) {
                // Convert Crypto USD to roughly INR equivalent for universal balance (1 USD = 83 INR mock)
                return tData.price * (tData.isCrypto ? 83 : 1);
            }
            // Fallback mock prices if not in top ticker buffer
            if(ticker.includes('USD')) return 83.5;
            if(ticker === 'ADA') return 45.5; 
            if(ticker === 'DOGE') return 12.3;
            return 1000.0; // generic fallback
        }

        async function fetchLiveTickerData() {
            try {
                // Real Binance API for Crypto Quotes (Public, no key required)
                const res = await fetch('https://api.binance.com/api/v3/ticker/24hr?symbols=["BTCUSDT","ETHUSDT","SOLUSDT"]');
                const data = await res.json();
                
                if(Array.isArray(data)) {
                    data.forEach(item => {
                        const target = tickerData.find(t => t.symbol === item.symbol);
                        if(target) {
                            target.price = parseFloat(item.lastPrice);
                            target.change = parseFloat(item.priceChangePercent);
                        }
                    });
                }
            } catch (error) {
                console.warn("Binance API fetch blocked or limited, using simulated micro-fluctuations.");
            }

            // Simulate real-time micro-fluctuations for Stocks/Forex 
            // (Since free live APIs for Indian markets block CORS strictly)
            tickerData.forEach(item => {
                if(!item.isCrypto) {
                    const fluctuation = (Math.random() - 0.5) * 0.005; // +/- 0.25% swing
                    item.price = item.price * (1 + fluctuation);
                    item.change = item.change + (fluctuation * 10); // arbitrary visual delta
                }
            });

            updateTickerUI();
            
            // If on dashboard, update real-time portfolio value
            if(!document.getElementById('page-dashboard').classList.contains('hidden') && userAccount) {
                updateDashboardUI();
            }
        }

        function updateTickerUI() {
            const createHTML = () => tickerData.map(t => {
                const colorClass = t.change >= 0 ? "text-green-500" : "text-red-500";
                const icon = t.change >= 0 ? "‚ñ≤" : "‚ñº";
                const formattedPrice = t.price < 10 ? t.price.toFixed(4) : t.price.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                return `<span class="mx-4 font-semibold">${t.display} <span class="text-gray-400 text-xs ml-1">${formattedPrice}</span> <span class="${colorClass} ml-1">${icon} ${Math.abs(t.change).toFixed(2)}%</span></span> ‚Ä¢`;
            }).join(" ");

            const htmlString = createHTML();
            
            const homeTicker = document.getElementById('live-ticker-track-home');
            if(homeTicker) homeTicker.innerHTML = htmlString + htmlString; // Doubled to loop seamlessly

            const marketsTicker = document.getElementById('live-ticker-track-markets');
            if(marketsTicker) marketsTicker.innerHTML = htmlString + htmlString;
        }

        // Initialize Ticker and refresh every 15 seconds
        fetchLiveTickerData();
        setInterval(fetchLiveTickerData, 15000);


        /* --- AUTHENTICATION & PAPER TRADING LOGIC --- */

        function toggleLoginModal() {
            document.getElementById('login-modal').classList.toggle('hidden');
        }

        function processLogin(e) {
            e.preventDefault();
            const username = document.getElementById('login-username').value;
            // Initialize Account with Portfolio Quantity object and History Array
            userAccount = { username: username, balance: 100000, portfolio: {}, history: [] }; 
            
            toggleLoginModal();
            updateAuthUI();
            
            // Re-render market screener to show "Trade" buttons
            switchMarket(activeMarket); 

            // Hide Hero Login Button
            const heroBtn = document.getElementById('hero-login-btn');
            if(heroBtn) heroBtn.classList.add('hidden');

            showModal(`Welcome to the trading floor, ${username}!<br><br>We have credited your wallet with ‚Çπ100,000 in paper trading funds. Access your Dashboard from the top menu to view your portfolio.`, "Authentication Successful");
        }

        function processLogout() {
            // Clear user session
            userAccount = null;
            
            // Revert UI elements
            updateAuthUI();
            
            // Re-render market screener to hide "Trade" buttons and show login prompt
            switchMarket(activeMarket);
            
            // Show Hero Login Button again
            const heroBtn = document.getElementById('hero-login-btn');
            if(heroBtn) heroBtn.classList.remove('hidden');

            // If user is on the dashboard while logging out, kick them back to the home page
            if (!document.getElementById('page-dashboard').classList.contains('hidden')) {
                navigateTo('home');
            }

            showModal("You have securely logged out of your trading account. See you next time!", "Logged Out");
        }

        function updateAuthUI() {
            const desktopWrapper = document.getElementById('auth-wrapper-desktop');
            const mobileWrapper = document.getElementById('auth-wrapper-mobile');
            
            if(userAccount) {
                const htmlDesktop = `
                    <button onclick="navigateTo('dashboard')" class="px-4 py-2 rounded-md text-sm font-bold bg-dark-800 text-gold-500 border border-gold-500/50 hover:bg-dark-700 transition flex items-center gap-2">
                        <i class="fa-solid fa-address-card"></i> My Dashboard
                    </button>
                    <button onclick="toggleDepositModal()" class="px-4 py-2 rounded-md text-sm font-bold bg-green-600/20 text-green-400 border border-green-500/50 hover:bg-green-600 hover:text-white transition flex items-center justify-center gap-2 shadow-[0_0_10px_rgba(34,197,94,0.2)]">
                        <i class="fa-solid fa-wallet"></i> ‚Çπ${userAccount.balance.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                    </button>
                    <button onclick="processLogout()" class="px-3 py-2 rounded-md text-sm font-bold bg-red-900/30 text-red-500 border border-red-500/30 hover:bg-red-600 hover:text-white transition flex items-center justify-center" title="Logout">
                        <i class="fa-solid fa-sign-out-alt"></i>
                    </button>
                `;
                const htmlMobile = `
                    <button onclick="navigateTo('dashboard'); toggleMobileMenu()" class="w-full text-center px-4 py-2 rounded-md text-sm font-bold bg-dark-800 text-gold-500 border border-gold-500/50 hover:bg-dark-700 transition">My Dashboard</button>
                    <button onclick="toggleDepositModal(); toggleMobileMenu()" class="w-full text-center px-4 py-2 rounded-md text-sm font-bold bg-green-600/20 text-green-400 border border-green-500/50 hover:bg-green-600 hover:text-white transition">‚Çπ${userAccount.balance.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</button>
                    <button onclick="processLogout(); toggleMobileMenu()" class="w-full text-center px-4 py-2 rounded-md text-sm font-bold bg-red-900/30 text-red-500 border border-red-500/30 hover:bg-red-600 hover:text-white transition">Logout</button>
                `;
                if(desktopWrapper) desktopWrapper.innerHTML = htmlDesktop;
                if(mobileWrapper) mobileWrapper.innerHTML = htmlMobile;
            } else {
                // Restore the default Login state when logged out
                const htmlDesktop = `
                    <button onclick="toggleLoginModal()" class="px-4 py-2 rounded-md text-sm font-bold bg-dark-800 text-gold-500 border border-gold-500/50 hover:bg-dark-700 transition"><i class="fa-solid fa-user mr-2"></i>Login</button>
                `;
                const htmlMobile = `
                    <button onclick="toggleLoginModal(); toggleMobileMenu()" class="w-full text-center px-4 py-2 rounded-md text-sm font-bold bg-dark-800 text-gold-500 border border-gold-500/50 hover:bg-dark-700 transition">Login</button>
                `;
                if(desktopWrapper) desktopWrapper.innerHTML = htmlDesktop;
                if(mobileWrapper) mobileWrapper.innerHTML = htmlMobile;
            }
        }

        function toggleDepositModal() {
            document.getElementById('deposit-modal').classList.toggle('hidden');
        }

        function processDeposit(e) {
            e.preventDefault();
            const amount = parseFloat(document.getElementById('deposit-amount').value);
            if(amount > 0) {
                userAccount.balance += amount;
                
                // Record transaction
                userAccount.history.unshift({
                    date: new Date().toLocaleString(),
                    type: 'DEPOSIT',
                    asset: 'INR',
                    qty: '-',
                    value: amount
                });

                updateAuthUI();
                if(!document.getElementById('page-dashboard').classList.contains('hidden')) updateDashboardUI();

                toggleDepositModal();
                showModal(`‚Çπ${amount.toLocaleString('en-IN')} has been securely added to your trading account.`, "Deposit Complete");
            }
        }

        function openTradeModal(assetName, assetTicker) {
            if(!userAccount) {
                showModal("You must be logged in to access the order book and execute trades.", "Authentication Required");
                toggleLoginModal();
                return;
            }
            
            selectedTradeAsset = { name: assetName, ticker: assetTicker };
            const estimatedInrPrice = getCurrentEstimatedPrice(assetTicker);
            const priceStr = `Live Ask: ‚Çπ${estimatedInrPrice.toLocaleString('en-IN', {maximumFractionDigits:2})}`;
            
            document.getElementById('trade-asset-title').innerText = `Trade ${assetTicker}`;
            document.getElementById('trade-asset-price').innerText = priceStr;
            document.getElementById('trade-modal').classList.remove('hidden');
            document.getElementById('trade-amount').value = '';
        }

        function closeTradeModal() {
            document.getElementById('trade-modal').classList.add('hidden');
        }

        function executeTrade(type) {
            const amountInr = parseFloat(document.getElementById('trade-amount').value);
            if(!amountInr || amountInr <= 0) return;

            const currentPrice = getCurrentEstimatedPrice(selectedTradeAsset.ticker);
            const quantity = amountInr / currentPrice;

            if(type === 'buy') {
                if(userAccount.balance >= amountInr) {
                    userAccount.balance -= amountInr;
                    
                    if(!userAccount.portfolio[selectedTradeAsset.ticker]) userAccount.portfolio[selectedTradeAsset.ticker] = 0;
                    userAccount.portfolio[selectedTradeAsset.ticker] += quantity;

                    userAccount.history.unshift({
                        date: new Date().toLocaleString(),
                        type: 'BUY',
                        asset: selectedTradeAsset.ticker,
                        qty: quantity,
                        value: amountInr
                    });

                    updateAuthUI();
                    closeTradeModal();
                    showModal(`Order filled successfully. Purchased ${quantity.toFixed(4)} ${selectedTradeAsset.ticker}.`, "Buy Order Executed");
                } else {
                    showModal("Insufficient buying power. Please deposit more funds into your wallet to execute this trade.", "Trade Failed");
                }
            } else if (type === 'sell') {
                const holdingQty = userAccount.portfolio[selectedTradeAsset.ticker] || 0;
                
                // User must enter INR value, we calculate if they have enough Quantity to cover that INR value
                if(holdingQty >= quantity) {
                    userAccount.portfolio[selectedTradeAsset.ticker] -= quantity;
                    userAccount.balance += amountInr; 
                    
                    userAccount.history.unshift({
                        date: new Date().toLocaleString(),
                        type: 'SELL',
                        asset: selectedTradeAsset.ticker,
                        qty: quantity,
                        value: amountInr
                    });

                    updateAuthUI();
                    closeTradeModal();
                    showModal(`Order filled successfully. Sold ${quantity.toFixed(4)} ${selectedTradeAsset.ticker}.`, "Sell Order Executed");
                } else {
                    const maxInrValue = holdingQty * currentPrice;
                    showModal(`Insufficient holdings. You only own ${holdingQty.toFixed(4)} ${selectedTradeAsset.ticker} (Approx. ‚Çπ${maxInrValue.toLocaleString('en-IN', {maximumFractionDigits:2})}).`, "Trade Failed");
                }
            }
        }

        /* --- DASHBOARD UI UPDATER --- */
        function updateDashboardUI() {
            if(!userAccount) return;

            document.getElementById('dash-greeting').innerText = `Welcome back, ${userAccount.username}. Here is your live portfolio.`;
            document.getElementById('dash-available-cash').innerText = `‚Çπ${userAccount.balance.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;

            // Calculate Portfolio Value & Render Holdings list
            let totalInvestedValue = 0;
            const holdingsContainer = document.getElementById('dash-holdings-list');
            holdingsContainer.innerHTML = '';

            const keys = Object.keys(userAccount.portfolio);
            if(keys.length === 0 || keys.every(k => userAccount.portfolio[k] <= 0.000001)) {
                holdingsContainer.innerHTML = `<p class="text-gray-500 text-sm text-center py-4">No assets in portfolio. Visit the screener to start trading.</p>`;
            } else {
                keys.forEach(ticker => {
                    const qty = userAccount.portfolio[ticker];
                    if(qty > 0.000001) { // Ignore tiny dust
                        const price = getCurrentEstimatedPrice(ticker);
                        const valueInr = qty * price;
                        totalInvestedValue += valueInr;

                        holdingsContainer.insertAdjacentHTML('beforeend', `
                            <div class="flex justify-between items-center bg-dark-900 p-3 rounded border border-dark-700">
                                <div>
                                    <div class="font-bold text-gray-200">${ticker}</div>
                                    <div class="text-xs text-gray-500">${qty.toFixed(4)} QTY @ ‚Çπ${price.toLocaleString('en-IN', {maximumFractionDigits:2})}</div>
                                </div>
                                <div class="text-right">
                                    <div class="font-bold text-white">‚Çπ${valueInr.toLocaleString('en-IN', {minimumFractionDigits:2, maximumFractionDigits:2})}</div>
                                </div>
                            </div>
                        `);
                    }
                });
            }

            document.getElementById('dash-invested-value').innerText = `‚Çπ${totalInvestedValue.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            
            const totalPortfolioValue = userAccount.balance + totalInvestedValue;
            document.getElementById('dash-total-value').innerText = `‚Çπ${totalPortfolioValue.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;

            // Render Transaction History
            const historyBody = document.getElementById('dash-history-body');
            historyBody.innerHTML = '';
            
            if(userAccount.history.length === 0) {
                historyBody.innerHTML = `<tr><td colspan="5" class="text-center py-8 text-gray-500">No transactions yet. Start trading in the Markets dashboard!</td></tr>`;
            } else {
                userAccount.history.forEach(tx => {
                    const typeColor = tx.type === 'BUY' || tx.type === 'DEPOSIT' ? 'text-green-500' : 'text-red-500';
                    const qtyStr = tx.qty === '-' ? '-' : parseFloat(tx.qty).toFixed(4);
                    
                    historyBody.insertAdjacentHTML('beforeend', `
                        <tr class="hover:bg-dark-800/50 transition">
                            <td class="px-6 py-4 text-xs text-gray-400 whitespace-nowrap">${tx.date}</td>
                            <td class="px-6 py-4 font-bold ${typeColor}">${tx.type}</td>
                            <td class="px-6 py-4 font-semibold text-white">${tx.asset}</td>
                            <td class="px-6 py-4 text-right text-gray-300">${qtyStr}</td>
                            <td class="px-6 py-4 text-right font-bold text-white">‚Çπ${tx.value.toLocaleString('en-IN', {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
                        </tr>
                    `);
                });
            }
        }

    </script>
</body>
</html>
